---
author: Junyi Zhou
date: "2019-11-05"
description: Review of Causal Inference
categories:
- Lectures/Slides
tags:
- Causal Inference
title: Review of Causal Inference

fontsize: 12pt

header-includes:
- <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
- <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
- \usepackage{setspace}\doublespacing
- \usepackage{array}
- \usepackage{booktabs}
- \usepackage{multirow}
- \usepackage{threeparttable}
- \usepackage{graphicx}
- \usepackage{mathtools}

indent: true

bibliography: bib_tex.bib
biblio-style: apa
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(knitr)
library(DT)
library(xtable)
library(kableExtra)
```


# Heterogeneous Treatment Effect Estimation
## 1. Introduction {#sec3.1}
The need for causal inference arises in many different fields. Economists want to quantify the causal effects of interest rate cut on the economy. Trade policy makers want to know whether increased tariff causes changes in trade deficit. Healthcare providers want to assess whether a therapy causes changes in specific patient outcomes. In this proposal, I examine the estimation of causal effects therapeutic treatments by using observational data in a population where the treatment effects vary by observed patient characteristics. Such estimation is essential for the practice of precision medicine, which by definition targets patients with specific characteristics to maximize the therapeutic benefit.

This work is proposed within the Rubin-Neymanâ€™s [@neyman1923application; @rubin1974estimating; @imbens2015causal] potential outcome framework. An essential feature of the potential outcome concept is that a given individual could have multiple potential outcomes, each under a different treatment; but since the subject only receives one treatment, only one of these potential outcomes is realized. The lack of observation on all potential outcomes within the subject makes it difficult to assess the effect of the treatment within the subject.

Denote the potential outcome from treatment $T$ as $Y^{(T)}$, where $T\in\{0,1,2,...,K\}$ corresponding to $K+1$ potential treatments. In most studies, people simply set $K=1$, that is there are only two possible treatments, namely treatment ($K = 1$) and control ($K = 0$). Two-arm scenario will be mainly discussed in *Introduction* and *Existing Methods* section and then extended to multiple arms in *Proposed Method* section. To further work on estimation of causal effects, we need to make Stable Unit Treatment Value Assumption (SUTVA, @rubin1980randomization): \
**Assumption 1. SUTVA** \
*1) Treatment applied to one unit does not affect the outcome for other units;* \
*2) There is no hidden variation, for example, different forms or versions of each treatment level, for a single treatment* \
and then the observed outcome for unit $i$ could be expressed as
$$
Y_i = \left\{
        \begin{array}{ll}
        Y_i^{(0)} & \quad \text{if} \quad T_i = 0 \\
        Y_i^{(1)} & \quad \text{if} \quad T_i = 1
        \end{array}
    \right.
$$
or equivalently,

\begin{equation}
Y_i = T_i Y_i^{(1)} + (1 - T_i) Y_i^{(0)}.  (\#eq:obsY)
\end{equation}

The causal (or treatment) effect is defined by the comparison between potential outcomes. For unit $i$, the individual treatment effect (ITE) $\xi_i$ is thus
\begin{equation*}
\xi_i = Y_i^{(1)} - Y_i^{(0)}.
\end{equation*}
Clearly, the definition of causal effect does not depend on which potential outcome is observed. Besides, ITE should be measured on the same unit, at same time point post-treatment. A direct observation and measurement of ITE is therefore infeasible. However, we are able to estimate the average individual treatment effect under plausible assumptions, which will be discussed in subsection 3.1.2. Here we first denote expected ITE for a specific unit $i$ with a vector of covariates $X_i$, or individual average treatment effect (IATE), as
$$
\tau(x) = E\left[ \xi_i \mid  X_i = x \right].
$$
IATE is conditioning on every single covariate which is a finest case of conditional average treatment effect (CATE), or heterogeneous treatment effect. CATE, on the other hand, can only conditional on part of the covariates that are of interest, which is the main target in the following discussions. The most coarse one is average treatment effect (ATE) which only measures the populational treatment effect, without taking subject features into consideration, noted as $\tau$ and
$$
\tau = E\left[\xi_i\right].
$$

For any observed potential outcome, we need to think of the reason why this outcome is realized instead of others. Clearly if the treatment is not randomly assigned, there must be some reason for a unit to take such treatment, which means that the treatment assignment is informative. Therefore, the estimation of ATE or CATE varies under different assignment mechanism. The discussion for randomized experiment is listed in subsection [1.1](#sec3.1.1) and observational studies in [1.2](#sec3.1.2).




### 1.1 Randomized Experiments{#sec3.1.1}
In randomized experiment, the treatment assignment is totally random which means
$$
T_i \perp (X_i, Y_i^{(0)}, Y_i^{(1)}),
$$
or equivalently,
$$
E[Y^{(k)}] = E[Y^{(k)} \mid  T] .
$$
Then the ATE could be calculated by
$$
\tau = E[Y_i^{(1)} - Y_i^{(0)}] = E[Y_i^{(1)} \mid T_i = 1] - E[Y_i^{(0)} \mid T_i = 0] = E[Y_i \mid T_i = 1] - E[Y_i \mid T_i = 0]
$$
where the last equality comes from equation \@ref(eq:obsY). Thus, the ATE could be easily obtained by taking the difference of two group average. This is how clinical trials measure the treatment effect between the proposed therapy against the placebo or standard therapy. However, even when the population treatment effect is not significant, the drug could still benefit a subgroup of the patients which could be hardly measured in traditional clinical trials.  

In order to see the subgroup treatment effect, we need to estimate CATE. The estimation of CATE in randomized experiments is the simplified version of that in observational studies, which just replace the propensity score (will be introduced in subsection [1.2](#sec3.1.1)) by constant values.

### 3.1.2 Observational Studies
In observational studies, the treatment assignment is related to the outcome and no longer fully random, which means 
$$
E[Y^{(k)}] \neq E[Y^{(k)} \mid T] 
$$
and hence, ATE is no longer trivial to obtain. In order to further explore the problem, a stronger assumption is usually provided in literature, namely unconfoundedness or ignorability \
**Assumption 2. Unconfoundedness**
\begin{equation}
(Y^{(1)}, Y^{(0)}) \perp T \mid X, (\#eq:assump2)
\end{equation}<!-- \tag{Assumption 2} --> 
which implies that there is no confounding covariates that are not observed. This is the fundamental assumption that frequently made in observational studies to rule out the potential confounders, since the unobserved confounding covariates could not cancel out as randomized experiments do. Sometimes it is followed by another assumption  \
**Assumption 3. Common Support**
\begin{equation}
0 < P(T_i = 1 | X_i = x) =\pi(x) < 1 (\#eq:assump3)
\end{equation}<!-- \tag{Assumption 3} --> 
which in combine called strong ignorability. Assumption \@ref(eq:assump3) is a common support regularization which means that in every corner of the covariate space, no arm will dominate. This assumption is often required in matching, weighting, and sub-classification related approaches to avoid the extreme value of propensity score (will be formally introduced in the next section).

With assumption \@ref(eq:assump2), consistency could be deduced 
$$
E[Y\mid T=1, X] = E[Y^{(1)}\cdot T + Y^{(0)}\cdot(1-T)\ \mid T=1, X] = E[Y^{(1)}\mid T=1, X],
$$
and similarly,
$$
E[Y\mid T=0, X] = E[Y^{(0)}\mid T=0, X].
$$
Then, population ATE can be written (for proof, please refer to [Appendix](#App)) as either
\begin{equation}
\tau = E_X\{ E[Y\mid T = 1, X] - E[Y\mid T = 0, X]\}, (\#eq:ATE1)
\end{equation}
or
\begin{equation}
\tau = E \left[\frac{TY}{\pi(X)} \right] - E \left[\frac{(1 - T)Y}{1-\pi(X)} \right] = E\left[ \frac{T-\pi(X)}{\pi(X)(1-\pi(X))}Y \right], (\#eq:ATE2)
\end{equation}
where $\pi(x) = E[T=1|X]$ is called propensity score that measures the possibility of receiving treatment. Similarly, the expression for **CATE** is either
\begin{equation}
\tau(x) =  E[Y\mid T = 1, X=x] - E[Y\mid T = 0, X=x], (\#eq:CATE1)
\end{equation}
or
\begin{equation}
\tau(x) = E \left[\frac{TY}{\pi(X)} \;\middle|\; X = x \right] - E \left[\frac{(1-T)Y}{1-\pi(X)} \;\middle|\; X=x \right] = E\left[ \frac{T-\pi(X)}{\pi(X)(1-\pi(X))}Y \;\middle|\; X = x\right].  (\#eq:CATE2)
\end{equation}
In some literature, the treatment indicator is denoted as $W = 2T-1 \in \{-1,1\}$, then equation \@ref(eq:ATE2) and \@ref(eq:CATE2) could be simply expressed by
\begin{align}
\tau &= E\left[ \frac{WY}{W\pi(X) + (1-W)/2} \right],  (\#eq:ATE3) \\
\tau(x) &= E\left[ \frac{WY}{W\pi(X) + (1-W)/2} \;\middle|\; X = x \right].  (\#eq:CATE3)
\end{align}

Almost every work aiming at finding ATE or CATE start from one of the above equations. For example, equation \@ref(eq:ATE1) and CATE1 are the foundation of conditional mean response methods, whereby the target is transformed to estimating conditional mean response $\mu_k(x) = E[Y \mid T = k, X=x], k \in \{0,1\}$. Equation \@ref(eq:ATE2), \@ref(eq:CATE2), \@ref(eq:ATE3), and \@ref(eq:CATE3) are the prototype of inverse probability weighted (**IPW**) methods which have been frequently used in modified outcome methods (**MOM**) or modified covariate methods (**MCM**). For instance, if both arm are equally allocated, that is $\pi = 0.5$, then equation \@ref(eq:CATE3) turns out to be
$$
\tau(x) = E\left[ 2WY \mid X=x \right] 
$$
which is the origin of MOM illustrated in @signorovitch2007identifying and @tian2014simple. More details of these methods will be illustrated in the next section.


The focus of this dissertation is the estimation of CATE in observational studies. 

    
## 2 Existing Methods {#sec3.2}
**Matching** is the most straightforward and original way of seeking CATE. Under the Assumption 1, 2 and 3, for an individual, as long as we could find another one with the exactly the same covariates $X$ and belongs to different treatment arm, then the expected difference in response of this two individual equals $\tau(X)$
$$
E[Y \mid T = 1, X = x] - E[Y \mid T= 0, X = x] = E[Y^{(1)} \mid X = x] - E[Y^{(0)} \mid X = x] = \tau(x).
$$
However, in real observational studies, such perfectly matched pair may not be easily found, and even found, a single paired difference it is not the expected difference which might involve a large uncertainty. 
  
Since it is almost impossible to find a perfect match, especially in high dimensional space, people try to figure out a way that only match on important covariates to ease the process. This branch of studies finally ruled by the milestone work from @rosenbaum1983central who illustrate that only matching by propensity score is good enough
$$
E[Y \mid T = 1, \pi(x)] - E[Y \mid T= 0, \pi(x)] = E[Y^{(1)} \mid \pi(x)] - E[Y^{(0)} \mid \pi(x)] = \tau(\pi(x))
$$
under assumption \@ref(eq:assump2). Since then, the whole matching task is transformed from a high dimensional space to a linear one, but how to achieve a good estimator of propensity score $\pi(X)$ turns out to be the key problem. 
  
However, as long as using paired matching, people always suffers from the larger variance coming from a single estimate. This leads to **subclassification** approach that seeks a group of units share similar, or same, which is the perfect scenario, propensity score. As long as at least one unit is in the different treatment group, the difference between the averaged outcome within each subgroup equals the desired treatment effect at given propensity score. It could help to reduce the estimation error by taking the average but if there is not enough samples at each propensity level, the benefit is quite limited. 
  
Matching or subclassification based on propensity score is tailored mainly for the estimation of ATE. After matching/subclassification at each covariate level, they take the average over all samples to achieve the final ATE 
$$
\begin{aligned}
E_{\pi(x)}\{E[Y \mid T = 1, \pi(x)] - E[Y \mid T = 0, \pi(x)] \} &= E_{\pi(x)}\{E[Y^{(1)} \mid \pi(x)] - E[Y^{(0)} \mid \pi(x)]\} \\
&= E[Y^{(1)} - Y^{(0)}] = \tau
\end{aligned}
$$
which does not hurt a lot by the missed values along $\pi(x)$. However, in estimation of CATE, there will be a lot of 'holes' in the estimators since it could be infinite numbers between $[0,1]$, and it is then less likely to do the prediction.
  
  @hirano2003efficient borrow the strength of equation \@ref(eq:ATE2) to directly estimate the ATE which only need to plug in the pre-estimated propensity score $\hat\pi(X)$ without matching and subclassification
\begin{equation}
\tau = \frac{1}{|\mathcal{D}|} \sum_{i \in \mathcal{D}}\left[ \frac{T_i-\hat\pi(X_i)}{\hat\pi(X_i)(1-\hat\pi(X_i)}Y_i \right]. (\#eq:hirano)
\end{equation}
They also claim that this will yield an efficient estimate of ATE. Since the propensity score appears on the denominator to weight the outcome, this method is then called **weighting**, or **Inverse Probability Weighting (IPW)**. Many later literature estimating CATE follows this idea. But the key flaw in this method is the large variability and computational instability introduced by the boundary value of propensity score, for example 0.


To sum, to estimate CATE, or to recommend the optimal treatment, there are mainly two problems to solve: 1) how to define the loss metric and 2) how to model and achieve the estimators and/or the nuisance parameters in the loss function. For loss functions determination, there could be either direct way or indirect way, which will be mainly discussed in subsection 3.2.1. For example, in methods described by equation \@ref(eq:hirano), the loss function is actually measuing the loss in estimated propensity score, which is an indirect way. Moreover, a proper modeling and estimation of $\pi(x)$ is the key to the success. Current methods include model based methods, kernel based methods, and other machine learning methods including, but not limited to regression tree, classification tree, and support vector machine (SVM). 

The structure of this section is designed as follows. The loss metrics that are frequently adopted in current literature will be discussed in subsection [2.1](#sec3.2.1). In subsection [2.2](#sec3.2.2), we will demonstrate the estimation algorithms that used to solve the loss functions. 


### 2.1 Loss Metric{#sec3.2.1}
The most different and difficult part in causal inference is the true IATE could never be observed. So no matter what estimation algorithm--either parametric or non-parametric method--is used, a direct evaluation of the loss in estimated treatment effect $\hat\tau(X)$ is infeasible. Following the literature in this field, we measure the loss between $\hat\tau(X)$ and $\tau(X)$, denote as $l(\hat\tau, \tau)$, by Mean Squared Error (MSE) 
\begin{equation}
\mathbb{E}[l(\hat\tau, \tau)] = \frac{1}{|\mathcal{D}|}\sum_{i \in \mathcal{D}} \left(\hat\tau(x_i) - \tau(x_i) \right)^2,  (\#eq:Loss)
\end{equation}
where $\tau(\cdot)$ is the real CATE that is unknown, $\mathcal{D}$ is observed dataset, and $|\mathcal{D}|$ is the size of the it. Generally, there are two main branches to work around this problem, either to avoid directly calculating $\tau$-loss function, named **Indirect Loss Function**, or to approximately evaluate it, called **Direct Loss Function Approximation**. 

#### Indirect Loss Function
##### Propensity Score Based Methods
Aforementioned matching, weighting, and subclassification methods belong to this category. Among these methods, an accurate estimation of the propensity score is the essence but estimating $\tau(x)$ accurately is not the direct goal. Due to the conditional independence, the estimation of $\pi$ has nothing to do with outcome $Y$, which might be its shortcomings due to not fully use the observed information. The corresponding loss function is
$$
\arg\min_\gamma  -\sum_{i \in \mathcal{D}} \log[W_i \pi(X_i;\gamma) + (1-W_i)/2],
$$
where $W_i = 2T_i -1 \in \{-1,1\}$. If the propensity score (PS) adopts the logit function, then it is equivalent to the logit loss function:
$$
\arg\min_\gamma  \sum_{i \in \mathcal{D}} \log\left[1 + e^{-W_i X_i^T\gamma}\right].
$$
In many latter studies, estimating $\hat\pi(X)$ is just an intermediate and inevitable step.

##### Conditional Mean Based Methods
Another set of straightforward methods follow directly from equation \@ref(eq:CATE1) that the estimation of CATE $\tau(X)$ is accomplished by the estimation of the conditional means $\mu_k(X), k \in \{0,1\}$
$$
\hat\tau(X) = \hat\mu_1(X) - \hat\mu_0(X).
$$
There are two different approaches to estimate $\mu_k(X)$. One is to train separate models for treatment group and control group. The other is to train a single model but treat treatment indicator as an additional covariate. The former one sometimes is named as **T-learner** (stands for two-learner) and the latter one is **S-learner** (stands for single-learner) according to @kunzel2019metalearners. The objective here turns out to be either minimize 
$$
\arg\min_{\beta^{(k)}} \mathbb{E}\left\{\left(Y - \mu_k(X;\beta^{(k)}) \right)^2\right\}, \quad k \in \{0, 1\}
$$
for T-learner, where $\beta^{(k)}$ is a set of parameters for model $\mu_k(\cdot)$ , or 
$$
\arg\min_\beta \mathbb{E}\left\{\left(Y - \mu(X, T;\beta) \right)^2\right\}
$$
for S-learner, where $\mu(X, T=k;\beta) = \mu_k(X;\beta)$, and $\beta$ are the parameters for $\mu(\cdot,\cdot)$. Since both loss metric is not direct focusing on CATE, we categorize this method in indirect loss function branch. 

Any machine learning algorithms could be used to fit conditional means, for example, kernel regression models with $L_1$-penaly, regression trees, or Bayesian Additive Regression Tree (BART, @chipman2010bart). This branch of methods seems reasonable, but actually suffer from the fact that minimizing the loss function of $\mu_i(x)$ does not guarantee the optimal estimation of $\tau(x)$. The MSE of $\hat\tau(X)$ could be expanded as follows
\begin{align*}
  E[\tau(X) - \hat\tau(X)]^2 &= E[(\mu_1(X)-\hat\mu_1(X)) - (\mu_0(X) - \hat\mu_0(X))]^2 \\
  &= MSE(\mu_1) + MSE(\mu_0) - 2E[(\mu_1(X)-\hat\mu_1(X))(\mu_0(X) - \hat\mu_0(X))]
\end{align*}
where $\text{MSE}(\mu_k) = \mathbb{E}[(\mu_k(X)-\hat\mu_k(X))^2]$. Notice that minimize MSE($\mu_k$) is not equivalent to minimize $\mathbb{E}[l(\hat\tau, \tau)]$ and no matter how good we fit $\mu_k(X)$, we still have no idea the goodness of $\hat\tau(X)$. 

##### Propensity Score + Conditional Mean
Most of the research works involve estimating both response surface/conditional mean and treatment assignment mechanism/propensity score for observational studies. For example, @robins2000marginal propose a weighted least squares (WLS) regression estimator for modeling the conditional mean response and the weight is the inverse of propensity score. However, for these methods, if the model of $\mu_k(\cdot)$, or $\pi(\cdot)$ is mis-specified, then the results are no longer consistent [@kang2007demystifying; @freedman2008weighting; @imai2014covariate]. So a double robust concept is proposed by @bang2005doubly, which involved both estimation of $\mu_i(\cdot)$ and $\pi(\cdot)$, and as long as one of the models is correctly specified, the double robust estimator is still consistent. That means people have two chances of guessing the true model and the odds of obtaining consistent estimator increases accordingly. The expression of doubly robust (DR) estimator of $\tau$ is actually a combination of equation \@ref(eq:ATE1) and \@ref(eq:ATE2)
\begin{equation}
\tau_{DR}(X) = \mu_1(X) - \mu_0(X) + \frac{T(Y-\mu_1(X))}{\pi(X)} - \frac{(1 - T)(Y-\mu_0(X))}{1 - \pi(X)}. (\#eq:DR) 
\end{equation}
$\hat\tau_{DR}(X)$ is obtainable by plugging in pre-estimated $\hat\mu_i(X)$ and $\hat\pi(X)$. However, the biggest problem is once both models are not correctly specified, the DR results could be even worse then other comparable methods [@kang2007demystifying; @imai2014covariate].  


##### Individual Treatment Rule (ITR) Based Methods
In many applications, an accurate treatment effect estimation may not be the prior interest and people only want to know which treatment is the best for an individual. This leads to a different idea that not estimating treatment effect directly but seeking the optimal treatment assignment. The individual treatment rule (ITR) based methods pursue the best overall outcomes. If larger $Y$ the preferred, then the objective function is
$$
\arg\max_g V(g),
$$
where 
$$
V(g) = E_g[Y] = \left\{
        \begin{array}{ll}
            E[\mu_1(X)]g(X) + E[\mu_0(X)](1-g(X)) & \quad \text{Plain Version} \\
            E\left[ \frac{1[T = g(X)]}{\pi^c(X) }Y\right] & \quad \text{IPW Version} \\
            E\left[ \frac{1[T = g(X)]}{\pi^c(X)}Y - \frac{1[T = g(X)]-\pi^c(X)}{\pi^c(X)}\{\mu_1g(X)+\mu_0(1-g(X))\}\right] & \quad \text{DR Version}
        \end{array}
    \right.
$$
and $\pi^c(X) = W\pi(X) + (1-W)/2$, where $W = 2T-1 \in \{-1,1\}$. 

Apparently, one challenge in IRT based methods is the optimization of non-convex and non-continuous objective function. Usually it is not easy to be solved by many off-the-shelf algorithms. Besides, the estimators for CATE is not readily obtained as a by-product which might be its drawback if people want CATE as well. In @qian2011performance, they use the plain version, and avoid computing issue by first figuring out conditional mean estimators, and then determine the optimal region $g(\cdot)$. The error will accumulate during the two-step estimation procedure and final regime might be sensitive to the $\hat\mu(X)$. @zhang2012robust worked on IPW (inverse probability weighting) and DR (doubly robust) version and provide two approaches to solve the objective function, one is grid search, which is almost impossible in high dimensional cases, the other is a generic algorithm by Goldberg (1989) with R package **rgenoud** (Mebane and Skehon, 2011). @zhao2012estimating transformed the objective function a little bit and put it into the framework of SVM and successfully solve it. But SVM suffers from multilevel classification, that is, this method could not be easily extended to multiple treatment studies. Furthermore, SVM could not handle imbalanced allocation well and also weak in $p \gg n$ cases. @chen2017general provided a general framework to this set of problems which could also quantify the treatment effect (not just the regime). What they did is actually figuring out a way to connect optimal regime finding to the direct loss function calculation (will be discussed in next subsection) which put a closure to this pipeline.



#### Direct Loss Function Approximation
The main idea is that even though we cannot observe $\tau(X)$ directly, we could replace the unknown $\tau(X)$ in equation \@ref(eq:Loss) by some available proxies with the property that minimizing this new loss function is equivalent to minimizing the target loss function \@ref(eq:Loss). Most methods to discuss in this subsection are in the category of modified variate methods (MVM), which consists of modified outcome methods (MOM) and modified covariate method (MCM). 

##### Modified Outcome Methods (MOM)
Suppose there exists $\tau(X) = E[Y^* \mid X]$, where $Y^* = c Y$, we are able to show that minimizing the proxy loss function 
$$
E[l(\hat\tau, Y^*)] = E[\{\hat\tau(X) - Y^*\}^2] = E[\{\hat\tau(X) - \tau(X) + \tau(X) - Y^*\}^2] = E[\{\hat\tau(X) - \tau(X) \}^2] + Var(Y^*)
$$
is equivalent to minimizing $E[l(\hat\tau, \tau)]$ since $Var(Y^*)$ is a constant. As the modification is made upon the outcome $Y$ to $Y^*$, it gets the name modified outcome method.

  @signorovitch2007identifying first explores this idea in his PHD dissertation based on the relationship $\tau(X) = E[2WY \mid X]$. The objective is then to minimize the loss function
\begin{equation}
E\left[ \{\hat\tau(X)-2WY \}^2 \right]. (\#eq:MOMraw)
\end{equation}
If further assuming the linear structure of CATE, that is $\tau(X) = X^T\beta$, then the minimization task can be simply done by fitting a linear model 
\begin{equation}
2WY = X^T\beta + \varepsilon 
\end{equation}
if the outcome $Y$ is continuous. But $\tau(X) = E[2WT]$ holds only in 1\:1 randomized experiments, an IPW version of MOM is designed for observational studies. Based on equation \@ref(eq:CATE2), the loss function for IPW version MOM is very straightforward
\begin{equation}
E[l(\hat\tau, \tau)] = E\left[ \left\{ \hat\tau(X)- \frac{T - \pi(X)}{\pi(X)(1-\pi(X))}Y \right\}^2 \right], (\#eq:MOMipw)
\end{equation}
where $\pi(X)$ is usually pre-estimated separately. Just as other IPW based methods, the results are sensitive to propensity score and no longer consistent when the model of $\pi(\cdot)$ is mis-specified [@knaus2018machine]. 

  Similarly, adopting equation \@ref(eq:DR), we can develop the DR version of MOM. We do not further explore the possible proxies here. The main issue for MOM is that the outcome is required to be continuous and cannot be extended to a various type of outcomes. Therefore, MCM methods are proposed to fix this issue.

##### Modified Covariate Methods (MCM)
MCM is first developed in @tian2014simple who modified MOM methods by adjusting the proxy loss function a little bit
$$
E[\{\hat\tau(X) - Y^*\}^2] = E[c^2\{\hat\tau(X)/c - Y\}^2]
$$
and then minimizing the right-hand-size, which is the loss function for MCM, targeting on $\hat\tau(X)$ directly as well. This branch of methods are fundamentally similar to MOM but do not make modification on the outcome, resulting in no restriction on $Y$. If under the linear assumption of $\hat\tau(X) = X^T\beta$, the original covariates $X$ is then turned to be $X/c$, and this is where the name modified covariate comes from. Furthermore, the CATE can be easily obtained using weighted least square methods, where $c^2$ is the weights.

  For example, the MCM version of the loss function \@ref(eq:MOMraw) is thus
$$
E\left[ \{\hat\tau(X)\cdot W/2-Y \}^2 \right].
$$
For MOM-IPW version, with some modification on \@ref(eq:MOMipw), the loss function for MCM-IPW version is derived as
$$
E\left[ \left\{ \hat\tau(X) \cdot [(W+1)/2 - \pi(X)]- Y \right\}^2  \right]
$$
and with further adjustment, it turns out to be
$$
E\left[ \frac{\left\{ \hat\tau(X)\cdot W- Y \right\}^2}{W\pi(X) + (1-W)/2} \right].
$$
These two loss functions are actually the two methods proposed by @chen2017general after generalizing the ITR method.

Note that only the linear structure on $\hat\tau(X)$ in MVM based methods [@tian2014simple; @nie2017quasi; @knaus2018machine] has been studied in the literatures due to the simplicity and ease in computation, though it is limited in scope. For more complicated proposed structure of $\hat\tau(X)$, general optimization algorithms could be directly applied on these loss functions. 

##### R-learner
R-learner [@nie2017quasi] is the only method that does not directly rely on equation \@ref(eq:ATE1) - \@ref(eq:CATE3). Technically, however R-learner can still be regarded as a MOM based method. We highlight it here because it is different from previous methods and more importantly, it builds the techinical foundation of our proposed method. R-learner method mainly bases on Robinson's [@robinson1988root] transformation 
$$
Y - m(X) = \{T - \pi(X)\}\tau(X) + \varepsilon,
$$
where the marginal mean function $m(X) = E[Y \mid X]$. Then the loss function is aiming to minimize
$$
\arg\min_\tau E[\varepsilon^2(\tau)]=\arg\min_\tau E[\left\{Y - m(X) - (T - \pi(X))\tau(X)\right\}^2].
$$
After some algebra, it is equivalent to
$$
\arg\min_\beta E\left[(T - \pi(X))^2\left\{ \hat\tau(X;\beta) - \frac{Y - m(X)}{T - \pi(X)}\right\}^2 \right]
$$
which is a typical form of MOM loss function. In Nie's work, they assume a linear structure of $\hat\tau(X)$ as well and estimate it with a two-step procedure by first calculate $\hat{m}(X)$ and $\hat\pi(X)$. 

Overall, the direct loss function based methods are usually more popular as it directly measures the loss of $\hat\tau(x)$. On the other hand, comparing to indirect loss functions, the requirement of additional assumptions to model $\tau$ could be a serious drawback for this set of methods. Many methods, and almost all the direct loss functions based methods involve a two-step procedures, i.e. first estimate $\hat\mu_k(\cdot)$, $\hat\pi(\cdot)$, or $\hat{m}(\cdot)$, and then plug into the final loss functions to obtain $\hat\tau(\cdot)$. So the accuracy of these nuisance estimators is critical to the consitency of treatment effect estimation. 


### 2.2 Estimation Algorithm{#sec3.2.2}
Construction of objective loss function transforms the causal inference problem in observational studies into a mathematical optimization problem. So the next step is to figure out the estimators that appear in the loss function, they are $\hat\mu_k(x)$, $\hat\pi(x)$, $\hat{m}(X)$, and $\hat\tau(x)$. The forthcoming discussion will focus on parametric methods, kernel-based methods, and machine learning algorithms, mainly tree-based algorithms.

#### Parametric Methods
The estimation is generally carried out by working with generalized linear model (GLM). For instance, it is very common to estimate propensity score by a logistic regression
$$
logit(\pi) = X^T\beta.
$$
In many indirect loss metric methods, people often estimate CATE $\tau(X)$ by a linear model $\tau(X) = X^T\beta$ along with LASSO to accomplish variable selection for all direct loss metric. But it is not very often to see people directly use linear model in estimation of conditional means. Parametric models enjoy the benefits of simplicity in both theoretical proof and computation, but are overly restricted to the specified models. 


#### Kernel-based Methods
As one of the most popular non-parametric methods, the kernel-based model is readily used for estimating the propensity socre, for example,
$$
\hat\pi(x) =\frac{\sum_{i = 1}^n T_iK\left(\frac{X_i - x}{h} \right) /nh^k}{\sum_{i = 1}^n K\left(\frac{X_i - x}{h} \right)/nh^k}
$$
in @abrevaya2015estimating. Then they plug this estimator into equation \@ref(eq:CATE2), $\hat\tau(x)$ can be obtained by locally weighted approach. For direct loss metric, @chen2017general adopted B-spline based additive model to estimate $\hat\tau(x)$. $L_1$ penalty is also commonly used in kernel based methods to control the complexity of the models. 

#### Tree-based Methods
@athey2015machine, @athey2016recursive, @wager2018estimation, @athey2019generalized, provided a very comprehensive view of incorporating tree-related algorithm (CART, @breiman2017classification; bagging, @breiman1996bagging; boosting, @freund1996experiments; gradient boosting, @friedman2001greedy) into the estimation of CATE. These methods could also be further split into two branches: regression trees, and causal trees. In our framework, regression trees are deemed as using indirect loss metric during tree construction, while causal trees adopt direct loss metric. 

  The regression trees based methods follow the idea of estimating $\mu_k(x)$ by CART or random forests. The idea is no different than using kernel based methods to estimate conditional means but different learning algorithms. For tree-related algorithms, it is more or less to conduct subclassification so that each leaf represents homogeneous subjects and the outcome could be estimated by leaf mean. People could build up two trees and each one aims at one treatment group corresponding to T-learner, or a single tree, following S-learner idea, that treatment indicator can be used to split trees. These methods provide a non-parametric estimator of conditional mean response $\hat\mu_k(x)$, and the estimated treatment effect is simply $\hat\tau(x) = \hat\mu_1(x) - \hat\mu_0(x)$. 
  
  Aside from estimating conditional means by traditional regression tree methods, Bayesian Additive Regression Trees (BART) method was also adopted in @hill2011bayesian. BART [@chipman1998bayesian; @chipman2002bayesian; @chipman2010bart] has a similar structure to boosting tree [@freund1996experiments] but each tree is considered as a function of mapping covariates to the outcomes. So each tree is a model and tree structures, including depth of the tree, the mean value at final leaves, are the model parameters. With the assumption that units in the same leaf is normally distributed, the likelihood for a set of trees could be written out and with proper prior assumption for the parameters, posterior distribution is calculated via an iterative Bayesian backfitting MCMC algorithm. Even though this method adopts T-learner, an indirect loss metric, it is one of the top performers (based on bias and RMSE) among 15 black-box algorithms in estimation of CATE across 20 data sets, according to @dorie2019automated.
  
  Causal trees, on the other hand, are no longer targeting at homogeneous outcomes during the tree construction but looking into the causal effect. Therefore, the loss functions to get minimized at each step are the direct loss metrics. For instance, considering MOM-IPW case [@athey2015machine; @powers2018some], 
$$
Y^* \leftarrow \frac{T - \tilde\pi(X)}{\tilde\pi(X)(1 - \tilde\pi(X))}Y 
$$
where $\tilde\pi(X)$ usually needs to be estimated separately. If directly build up a tree for this transformed outcome $Y^*$, and adopt MSE as split rule, then the loss function at each step is
$$
\sum_{l=1}^L \sum_{i \in \mathcal{S}_l} \left( Y_i^* -  \bar{Y}_i^*\right)^2 = \sum_{i} \left( Y_i^* -  \hat{\tau}(X_i)\right)^2, 
$$
where $\mathcal{S}_l$ represents the set of units in node $l$, and $\bar{Y}^*$ is the mean of $Y^*$ within each node
$$
 \bar{Y}_i^* = \frac{1}{|S_l|}\sum_{i \in\mathcal{S}_l}Y^*_i = \hat{\tau}(X_i).
$$
As we have already seen in previous section, this loss function leads to the target of minimizing the loss of $\hat\tau(X)$. 

  This direct application is very straightforward theoretically, but may involve some bias if directly plug in the pre-estimated propensity score to adjust for the outcomes of a subpopulation in a single leaf. So a weighted average way of estimating $\hat\tau(x)$ is proposed in @athey2015machine. In the same paper, they also formally named a tree based algorithm **causal tree** which uses transformed outcome as outcome and maximizes the total treatment effect as objective function. Hence the loss function can be set as
$$
Loss = -\sum_i \hat\tau(X_i)^2.
$$
  
Notice that the above estimation methods could be used simultaneously to solve a single objective function. For example, in Nie's work, they used a logistic regression with LASSO in estimation of propensity score and a linear model for $\tau(X)$, but kernel-based methods in other parameters. In @athey2015machine, they first estimated propensity scores from logistic models and then plug the estimators in the tree based algorithms.

#### Support Vector Machine (SVM)
SVM is only used in solving ITR problem due to its strength in handling discontinuous loss function [@zhao2012estimating; @imai2013estimating]. But SVM usually is hard to extend to multiple treatment scenarios. So we will not explore further on SVM considering our target is the recommendation of the optimal treatment from a number of alternatives.


    
## 3 Proposed Method {#sec3.3}
The current methods mainly discuss the scenario of two arms, treatment versus control. Even though in many literature, authors claim that their methods could be extended to multiple treatment cases, none of them really implemented it. Our proposed method is tailored for such complicated scenario and at the same time provide an alternative approach to the existing methods. Following the structure in [Section 2](#sec3.2), the proposed method will also be explored in two parts: loss metric and estimation algorithm. 

Following the notation in [Section 1](#sec3.1), assuming there are a total of $K+1$ treatments, $T\in\{0,1,2,...,K\}$ and denote $T=0$ the standard therapy or placebo. The covariate-specific causal effect for the $k^{th}$ treatment against standard therapy is
$$
\tau^{(k)}(X) = E[Y^{(k)} - Y^{(0)}|X],
$$
and our goal is to recommend a therapy based on covariates $X$ that could maximize the treatment effect
$$
\text{Recommended Treatment } T^* = \arg\max_k \tau^{(k)}(X).
$$


### 3.1 Proposed Loss Metric{#sec3.3.1}
We extended the R-learner [@nie2017quasi] into multiple treatments scenario following the Robinson's decomposition [@robinson1988root]. The reason we adopt this loss metric is 1) this loss metric targets directly at minimizing the estimation error of $\tau(x)$; 2) it holds for any outcome distribution, including binary outcomes, so that we do not need any extra modification like MVM metric; 3) the propensity scores do not appear on the denominators which avoid potential computing issues as well as additional variability.

Under Assumption 1,  
$$
\begin{aligned}
E[Y \mid T, X] &= E\left[ \sum_{k=1}^{K} 1[T=k]Y^{(k)} \;\middle|\; T, X \right] 
= \sum_{k=1}^{K} 1[T=k] E\left[ Y^{(k)} \mid T, X \right] \\
&= \sum_{k=1}^{K} 1[T=k] \left(\tau^{(k)}(X) + E[Y^{(0)} \mid X] \right) \\
&= E[Y^{(0)}\mid X]  + \sum_{k=1}^{K} 1[T=k] \tau^{(k)}(X)
\end{aligned}
$$
and we could re-write this term by plugging in the conditional mean outcome 
$$
m(X) = E[Y \mid X] = E\left[ \sum_{k=1}^{K} 1[T=k]Y^{(k)} \;\middle|\; X \right] = E[Y^{(0)}\mid X]  + \sum_{k=1}^{K} \pi^{(k)}(X) \tau^{(k)}(X), 
$$
which follows that
$$
E[Y \mid T, X] = m(X) + \sum_{k=1}^{K} \left(1[T=k] - \pi^{(k)}(X)\right) \tau^{(k)}(X),
$$
where the propensity score for the $k^{th}$ treatment is denoted as $\pi^{(k)}(X) = E[1[T = k] \mid X] = \Pr[T = k \mid X]$. Hence, the estimator of $\hat\tau^{(\cdot)}(\cdot)$ could be obtained by minimizing the following loss function
\begin{equation}
\arg\min_\tau \left\{ E\left[ \left(Y - m(X) - \sum_{k=1}^{K} \left(1[T=k] - \pi^{(k)}(X)\right) \tau^{(k)}(X) \right)^2 \right] \right\}. (\#eq:Rloss)
\end{equation}



### 3.2 Proposed Estimation Algorithm{#sec3.3.2}
To accomplish the optimization, we adopt a two-step estimation process according to the shape of the loss function. First we need to estimate $m(X)$ and $\pi^{(\cdot)}(X)$, and then plug the estimators into equation \@ref(eq:Rloss). Besides, we need to propose a set of functions for the causal effects $\hat\tau^{(\cdot)}(X)$.

In order to handle the potential high dimension structure of the data, we adopt Generalized Additive Model (GAM) along with B-spline basis for the estimation of both conditional mean and propensity score. For the modeling of causal treatment effect, we combine the GAM with tree based learning algorithm to utilize the strength of both methods. 

#### Estimation of Conditional Mean Outcome $m(X)$
Suppose there are $P$ covariates, then the conditional mean outcome could be modelled by
$$
m(X) = \alpha + f_1(X_1) + f_2(X_2) + \cdots + f_P(X_P)
$$
where
$$
f_p(x) = \sum_{l=1}^{q_n} a_{lp}B_l(x).
$$

#### Estimation of Propensity Score $\pi^{(\cdot)}(X)$
For each propensity score, due to the binary outcomes, we adopt the logit link function
$$
\log \frac{\pi^{(k)}(X)}{1 - \pi^{(k)}(X)} = \beta^{(k)} + g^{(k)}_1(X_1) + g^{(k)}_2(X_2) + \cdots + g^{(k)}_P(X_P)
$$
where
$$
g^{(k)}_p(x) = \sum_{l=1}^{q_n} b^{(k)}_{lp}B_l(x).
$$

#### Proposed Models for Causal Treatment Effects $\tau^{(\cdot)}(X)$
In Nie's work, they simply assume a linear structure of $\tau(X)$ for the simplicity in proof. For a better fit and free from any model restrictions, we adopt GAM to model causal treatment effects
$$
\tau^{(k)}(X) = \gamma^{(k)} + h^{(k)}_1(X_1) + h^{(k)}_2(X_2) + \cdots h^{(k)}_P(X_P)
$$
where
$$
h^{(k)}_p(x) = \sum_{l=1}^{q_n} c^{(k)}_{lp}B_l(x).
$$

In the two-step estimation procedure, after obtaining $\hat{m}(X)$ and $\hat\pi^{(\cdot)}(X)$ in the first step, minimizing the loss function yield the estimates of $(\underline\gamma, \underline c)$
\begin{equation}
(\underline{\hat{\gamma}}, \underline{\hat{c}}) = \arg\min_{\underline\gamma, \underline c} \sum_{i=1}^n  \left(Y_i - \hat{m}(X_i) - \sum_{k=1}^{K} \left(1[T_i=k] - \hat\pi^{(k)}(X_i)\right) \tau^{(k)}(X_i;\underline\gamma, \underline c) \right)^2 . (\#eq:opt)
\end{equation}
The estimates of covariate-specific causal effects are then given by
\begin{equation}
\hat\tau^{(k)}(X) = \hat\gamma^{(k)} + \sum_{p = 1}^P\left(\sum_{l=1}^{q_n}\hat{c}^{(k)}_{lp}B_l(X_p)\right). (\#eq:tau)
\end{equation}

Instead of direct optimizing the loss function \@ref(eq:opt) with LASSO algorithm just as in Nie's work, we adopt a tree-based recursive partition algorithm to figure out the optimal causal treatment effect. The idea is to recursively split the node to grow a tree which could achieve the homogeneous leaves after completion and within each node, we estimate the treatment effects by equation \@ref(eq:tau). The details of generating trees will be further demonstrated in Section [3.3](#sec3.3.3). 

The main reason to adopt tree-based algorithm is the natural feature of tree-based algorithm that generate homogeneous leaves and assign heterogeneous units to different leaves perfectly matches our requirement of seeking heterogeneous treatment effects. Our ultimate goal is to find out the optimal covariate specific treatment, rather than figuring out the most accurate estimation of treatment effects, which is almost impossible. So we prefer not to directly solve equation \@ref(eq:opt) by LASSO but to subclassify homogeneous patients.

Our proposed method also differs from the current existing tree based algorithms. Causal tree based algorithms split the node according to the estimation of $\tau(X)$ in each node under the assumption of homogeneity. However, at the earlier stage of tree generation, the homogeneity assumption always invalid which lead to the bias in the $\hat\tau(X)$ and undermine the final estimators. In our methods, we estimate the treatment effect using GAM at each node without the need of homogeneity to avoid such issue. Besides, we propose an adaptive approach, which estimates the nuisance parameters $m(X)$ and $\pi^{(\cdot)}(X)$ within each node, that is very different from most current literatures who obtain the estimators based on the whole data set [@athey2015machine; @powers2018some; @wager2018estimation]. Our method also is model free comparing to @su2009subgroup, who split the tree by the statistics that testing the interaction effect between treatments and covariates in the linear model. 


Aside from those advantages comparing to the existing methods, adopting a tree structure helps to alleviate the potential problems of GAM. GAM is known for its great flexibility but has several limitations: 1) it is an additive structure which is not able to account for interaction effects; 2) GAM with B-splines regression is prone to overfit. For the first issue, tree structure, however, could capture the non-linearity even $\tau^{(\cdot)}(X)$ is estimated linearly in each leaf. A common way to solve overfitting issue is by adding penalty terms in the loss function, but it could be computationally very expensive in our case. Here we adopt the idea of random forest to subsample the covariates during the growth of each single tree to mitigate overfitting and simplify the optimization calculation as well.

### 3.3 Estimation Process{sec3.3.3}
Denote $\underline\tau = (\tau^{(1)}, \tau^{(2)}, ..., \tau^{(K)})$ and the estimated individual treatment effect from all treatment arms for the $i^{th}$ subject is $\underline{\hat\tau_i} = \left(\hat\tau^{(1)}(X_i), \hat\tau^{(2)}(X_i), ..., \hat\tau^{(K)}(X_i) \right)$. We propose the following algorithm to generate a single tree 

- **Step 1:** Split the current node into two parts, left subnode and right subnode, at a given value of one covariate. The samples in left and right subnode is denoted by set $\mathcal{S}_L$ and $\mathcal{S}_R$ respectively, each with size $N_L$ and $N_R$. At each subnode, we first fit $\hat{m}(X)$ and $\hat\pi^{(k)}(X), k = 1, 2, ..., K$ and further obtain the model parameters $(\underline{\hat{\gamma}}, \underline{\hat{c}})$ by solving equation \@ref(eq:opt). Then the estimation of the individual treatment effect $\underline{\hat\tau_i}$ is accessible by equation \@ref(eq:tau) which is called 'pseudo' causal effects, since they are mainly used for facilitating the tree build-up. Denote the obtained $N_L$ 'pseudo' outcomes in left subnode, 
$$
\hat\tau_L = \{\underline{\hat\tau_i} : i \in \mathcal{S}_L\}
$$
and for the right subnode, 
$$
\hat\tau_R = \{\underline{\hat\tau_i} : i \in \mathcal{S}_R\}.
$$
- **Step 2:** Then we calculate two-sample Hotelling's T-Square statistic to test the null hypothesis that the average treatment effect is the same in left and right subnode, that is $H_0: \tau_L = \tau_R$. This T-Square statistic is 
$$
T_H^2 = (\bar{\hat\tau}_L - \bar{\hat\tau}_R)^T \left\{S_p \left( \frac{1}{N_L} + \frac{1}{N_R} \right) \right\}^{-1} (\bar{\hat\tau}_L - \bar{\hat\tau}_R) 
$$
where 
$$
\begin{aligned}
\bar{\hat\tau}_L &= \frac{1}{N_L}\sum_{i \in \mathcal{S}_L} \underline{\hat\tau_i}, \\
\bar{\hat\tau}_R &= \frac{1}{N_R}\sum_{i \in \mathcal{S}_R} \underline{\hat\tau_i}, \\
S_p &= \frac{(N_L - 1)S_L + (N_R -1)S_R}{N_L + N_R - 2}
\end{aligned}
$$
with
$$
\begin{aligned}
S_L &= \frac{1}{N_L} \sum_{i \in \mathcal{S}_L} \left( \underline{\hat\tau_i} - \bar{\hat\tau}_L \right)\left( \underline{\hat\tau_i} - \bar{\hat\tau}_L \right)^T, \\
S_R &= \frac{1}{N_R} \sum_{i \in \mathcal{S}_R} \left( \underline{\hat\tau_i} - \bar{\hat\tau}_R \right)\left( \underline{\hat\tau_i} - \bar{\hat\tau}_R \right)^T.
\end{aligned}
$$
Since Hotelling's two-sample t-squared statistic is related to F-distribution
$$
\frac{N_L+N_R-K-1}{(N_L+N_R-2)K} T_H^2 \sim F(K, N_L+N_R-K-1),
$$
the p-value of the test is computed accordingly, denoted by $p_{val}$. However, a simple comparison of p-value at all possible split values is not fair unless adjusting for the total number of distinct values in the covariate $m$ (to handle multiple comparison), and the depth of the node $d$ (to pursue balanced tree and avoid overfitting). We recommend to use the adjusted logworth, that is
$$
a.logworth = -\log_{10}(2^d\cdot m\cdot p_{val}).
$$
After going through all the potential split points, the one provides the largest $a.logworth$ will be adopted to be the next split.

- **Step 3:** Repeat Step 1 and 2 until no further split could be made, or a certain stopping rule is met. 

- **Step 4:** After completing the growth of the tree, we need to prune the tree to the right size to avoid overfitting. Pruning and cross-validation can be a burden when statistical tests are used for splitting [@zeileis2008model; @athey2016recursive]. In our work, we propose to apply a different criterion in validation and pruning so that to achieve 'honest' trees as proposed by @athey2016recursive. Other than T-Square statistics, we adopt a direct measure of treatment effect 
$$
\sum_{i \in \{\mathcal{S}_L, \mathcal{S}_R\}} \max\{\underline{\hat\tau_i}\}^2
$$
to evaluate whether a split could help to maximize the overall benefits. The splits that could not improve the treatment effects in validation set will be removed.

- **Step 5:** For the final tree, each terminal node defines a homogeneous sub-population for treatment effects. Thus, the covariate specific treatment effects among all $K$ treatments could be treated as constants instead of modeling by GAM, and estimated by minimizing the loss function
$$
\underline{\hat\tau}(X) = \arg\min_\tau \sum_{i \in \{\mathcal{S}:X\in \mathcal{S}\}}  \left(Y_i - \hat{m}(X_i) - \sum_{k=1}^{K} \left(1[T_i=k] - \hat\pi^{(k)}(X_i)\right) \tau^{(k)} \right)^2.
$$


To reduce the variability of estimators from a single tree, we repeat Step 1 - 5 to generate a total of $B$ trees where the samples and covariates used for each tree is subsampled from the whole set. The final treatment effect for the $i^{th}$ subject is thus the average of the outcomes from $B$ single trees
$$
\underline{\bar{\hat{\tau}}_i} = (\bar{\hat\tau}_i^{(1)}, \bar{\hat\tau}_i^{(2)}, ..., \bar{\hat\tau}_i^{(K)})
$$
and the recommended treatment is the one that provides the optimal effect: $T^* = \{k: \bar{\hat\tau}_i^{(k)} = \max(\bar{\hat\tau}_i^{(1)}, \bar{\hat\tau}_i^{(2)}, ..., \bar{\hat\tau}_i^{(K)})\}$.


## 4 Application
In this section, I will introduce the application of proposed method on seeking the optimal antihypertensive therapies. Nowadays, hundreds of different type of antihypertensives are available in the market. The benefit of the antihypertensives varies across people due to different personal characteristics. To make things worse, for some person, only a combination of several antihypertensive drugs, which we call it an antihypertensive therapy, make effect. Our target is to find out the best antihypertensive therapy according to patient's characteristics by our proposed method. In the following sessions, we will introduce our data system, definition of cohort, and the potential problems when applying our method to the real observational data.

### 4.1 Data Scource
Our electronic medical record (EMR) data is collected from clinical records stored in the Indiana Network for Patient Care (INPC). The INPC includes most of the Regenstrief Medical Record System (RMRS) clinical data from Wishard Health Services, Indiana University (IU) hospitals, and Methodist Hospital. RMRS is one of the nation's first electronic medical record systems and the keystone of many activities at Regenstrief Institute. The data in the RMRS have been used previously for health care research and management purposes.

INPC is a 17-year-old health information exchange operated in Indiana. Regenstrief Institute made a pioneering commitment to standards, interoperability, and the interchange of clinical data for clinical, public health, and research purposes. Investigators at the Regenstrief Institute created the Indianapolis Network for Patient Care (INPC) in 1995 with the goal of providing clinical information at the point of care for the treatment of patients. The INPC includes clinical data from over 80 hospitals, the public health departments, local laboratories and imaging centers, and a few large-group practices closely tied to hospital systems, and plans are to expand these efforts. 

The INPC repository now carries 660 million discrete observations; 14.5 million text reports; 45 million radiology images; and 450,000 EKG tracings. These are now growing at the respective rates of 88 million, 2 million, 25 million, and 80,000 per year. 

The Regenstrief data system standardizes all clinical data, and laboratory test results are mapped to a set of common test codes (LOINC) with standard units of measure for patient care, public health, and research purposes. Each institution has the same file structure in the Regenstrief system and shares the same term dictionary, which contains the codes, names (and other attributes) for tests, drugs, coded answers, etc.


### 4.2 Cohort Definition
We will identify the cohort from medical records stored in INPC. We will use ICD9 code to identify cases of hypertension. To alleviate the concern about underdiagnoses of hypertension, we also examined recorded blood pressure in the medical records. An individual is considered to be hypertensive if his/her blood pressure meets the criteria for hypertension set forth by the *Seventh Report of the Joint National Committee on Prevention, Detection, Evaluation, and Treatment of High Blood Pressure* (JNC 7). The ICD9 codes used are provided in Table $\ref{tab:ICD9}$.

To meet the Standards for Privacy of Individually Identifiable Health Information (â€œPrivacy Rulesâ€) set by the Health Insurance Portability and Accountability Act of 1996, we sought and obtained permission from Indiana University Institutional Review Board to use de-identified data in this research. To comply with the privacy rules, we removed all identifiable information from the study data, including names, addresses, telephone numbers, social-security numbers, hospital identification numbers, etc. We also removed all calendar dates from the medical records and only kept calendar years of the recorded events such as medication prescriptions and dispensing, laboratory tests, outpatient and inpatient visits. To maintain the temporal sequence of recorded events, we designate the date of the initial diagnosis as the index date for that patient, i.e., time zero. All other record dates are indicated by the number of calendar days from the index date.  We recognize that the determination of time of â€œinitialâ€ diagnosis is not foolproof as it is conceivable that the patient could have been diagnosed earlier than our medical records showed. 

Our cohort for hypertension patients was extracted for a five year time period between 2004 to 2012. A total of 812,571 patients were identified as hypertension. But considering the fact of incompleteness, the total data available for use will be far less than this number, which may around 20k to 30k. 

\begin{table}[]
\caption{ICD-9 Code for Hypertension used in data extraction}
\label{tab:ICD9}
\resizebox{\textwidth}{!}{%
\begin{tabular}{p{1.2cm}|p{14cm}}
401.9 & Unspecified essential hypertension (hypertension occurring without preexisting renal disease or known organic cause) \\
401.1 & Benign essential hypertension \\
401.0 & Malignant essential hypertension \\
255.10 & Hyperaldosteronism, unspecified (abnormality of electrolyte function caused by excessive secretion of aldosterone by the adrenal cortex) \\
405.0 & Malignant secondary hypertension \\
405.9 & Unspecified secondary hypertension
\end{tabular}%
}
\end{table}

### 4.2 Potential Problems of EMR Data Application
- **Missing Data**. Mssing data is always an issue in observational studies, and it is even more severe for EMR data. Many variables, for example, the record of whether patient have had antibiotic recently, only a small portion (<1%) has the answer 'yes', but a large portion is missed. We need to make a proper assumption that those missed data are actually 'no'. 

- **Drug Adherence**. In observational studies, we have no idea of whether patients take medicine regularly as required or not. So we adopt two frequently used adherence measures: medication possession ratio (MRP) and proportion of days covered (PDC). Both MPR and PDC are validated adherence measures accepted by the International Society for Pharmacoeconomics and Outcomes Research (ISPOR).  We calculated MPR and PDC using medication transaction and/or pharmacy claim data stored in the electronic records of the INPC.

  The drug level adherence may be used as the covariate in estimation of propensity score. For patient level drug adherence, it may not make a lot of sense to use as a personal characteristics since we would not want to find some therapies that works for patients who do not adhere to the prescription, but rather we may use it to stratify the cohort and only focus on the sub-cohort with appropriate level of drug adherence.

- **Treatment Duration**. The strict definition of causal effect is to measure the difference of potential outcomes for the same person, at the same time point after treatment. To accomplish the estimation, we already loose the constraint to compare the potential outcomes from different patients. But for observational studies, we lose the control for the treatment duration as well. This may raise some criticism but considering the immediate effect of antihypertensives, the outcomes may not change a lot with the duration which could alleviate the issue.


\newpage
# Appendix {#App}
Proof of Equation \@ref(eq:ATE1):
$$
\begin{aligned}
\tau &\equiv E[Y^{(1)}] - E[Y^{(0)}] \\
&= E_X\{ E[Y^{(1)}|X] - E[Y^{(0)}|X]\} \\
&= E_X\{ E[Y^{(1)}|T = 1, X] - E[Y^{(0)}|T = 0, X]\} \ (Ignorability) \\
&= E_X\{ E[Y|T = 1, X] - E[Y|T = 0, X]\} \ (Consistency)
\end{aligned}
$$
Proof of Equation \@ref(eq:ATE2):
$$
\begin{aligned}
\tau 
&= E_X\{ E[Y|T = 1, X] - E[Y|T = 0, X]\} \\
&= E_X\left\{ \frac{E[Y|T = 1, X]\cdot E[T = 1|X]}{E[T = 1|X]} \right\} - E_X\left\{ \frac{E[Y|T = 0, X]\cdot E[T = 0|X]}{E[T = 0|X]} \right\} \\
&= E_X \left\{ E \left[\frac{TY}{\pi(X)}|X\right] \right\} - E_X \left\{ E \left[\frac{(1-T)Y}{1-\pi(X)}|X\right] \right\} \\ 
&= E \left[\frac{TY}{\pi(X)} \right] - E \left[\frac{(1 - T)Y}{1-\pi(X)} \right] .
\end{aligned}
$$

\newpage
# References
\small
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}
\setlength{\parskip}{8pt}
\noindent

